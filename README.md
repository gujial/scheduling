# eBPF 风水调度器

这是一个基于 sched_ext 的实验性调度器示例，主题是“八卦/五行/风水”策略：

- 通过进程行为画像计算卦象（CPU 计算强度、交互频率、内存足迹）
- 使用变卦逻辑处理 aging（运行/等待时间过长时调整卦象）
- 将不同卦象分发到 8 个 DSQ，并设置不同时间片
- 按卦象选择 CPU（启发式的大核/小核划分）
- 用户态程序负责初始化系统拓扑配置并写入 BPF map

## 构建并启动测试 VM

在宿主机执行：

1. 进入开发环境（可选，但推荐）：
   - `nix develop`
2. 构建 VM：
   - `nix build .#nixosConfigurations.ebpf-vm.config.system.build.vm`
3. 运行 VM：
   - `./result/bin/run-ebpf-test-vm`

VM 启动后会自动以 root 登录，宿主机工作区会挂载到 `/src`。

## 在 VM 中构建并加载

VM 启动后，在 VM 内执行：

1. 进入共享目录：
   - `/src/scheduling`
2. 生成并编译：
   - `make`
3. 以 root 加载：
   - `./sched`

按 Ctrl+C 退出并卸载。

## 调度策略概览

### 进程画像与定卦

在 `enqueue` 中实时计算三条“爻”，合成 8 卦：

- 计算强度：根据 `sum_exec_runtime` 的增量估算 CPU 利用率
- 交互频率：观察 `nvcsw`（自愿上下文切换次数）的变化
- 空间足迹：通过 RSS 估算内存占用

### 变卦（Aging）

根据运行/等待时间做状态纠偏：

- 纯阳（乾）运行过久会转为纯阴（坤）以降低优先级
- 纯阴（坤）等待过久会转为纯阳（乾）以避免饥饿
- 中等时长时可翻转最低位爻以调整卦象

### DSQ 与时间片

为八卦分别建立 DSQ，并设置不同的时间片：

- 乾、离：长时间片（10ms），面向高计算/高功耗
- 坎、坤：短时间片（1ms），偏向 IO/能效
- 其余卦象：标准时间片（5ms）

### dispatch 优先级

dispatch 会按优先级从各 DSQ 拉取任务：

1. 乾（高性能）
2. 离（高运算）
3. 震、兑（交互）
4. 巽（灵活）
5. 艮（稳定）
6. 坎（IO）
7. 坤（能效）

### CPU 选择（风水）

基于卦象做启发式选核：

- 乾偏向性能核心
- 坤偏向能效核心
- 震/兑优先保持或迁移到性能核心
- 离倾向分散到不同核心
- 艮倾向留在当前核心

用户态加载器会检测 CPU 数量并写入 `sys_config_map`，为 BPF 侧的选核逻辑提供拓扑信息。
